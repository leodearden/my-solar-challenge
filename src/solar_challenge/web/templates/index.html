{% extends "base.html" %}

{% block title %}Solar Challenge &mdash; Scenario Simulator{% endblock %}

{% block content %}
<div class="page-intro">
    <h1 class="page-title">Solar Scenario Simulator</h1>
    <p class="page-subtitle text-muted">
        Configure your household solar setup and run a simulation to see projected
        energy flows, self-sufficiency, and grid usage.
    </p>
</div>

<!-- Scenario Configuration Form -->
<div class="card">
    <h2 class="card__title">Configure Scenario</h2>

    <form
        id="simulation-form"
        hx-post="{{ url_for('main.simulate') }}"
        hx-target="#results-section"
        hx-swap="innerHTML"
        hx-indicator="#loading-indicator"
    >
        <!-- Hidden date fields computed from 'days' selection by JS -->
        <input type="hidden" name="start" id="start-date" value="2024-01-01">
        <input type="hidden" name="end" id="end-date" value="2024-01-07">

        <div class="form-grid">

            <!-- PV Capacity -->
            <div class="form-group">
                <label for="pv_kw">PV Capacity (kW)</label>
                <input
                    type="number"
                    id="pv_kw"
                    name="pv_kw"
                    class="form-control"
                    min="1"
                    max="12"
                    step="0.5"
                    value="4"
                    required
                    aria-describedby="pv-hint"
                >
                <span id="pv-hint" class="hint">Solar panel array size &mdash; 1 to 12 kW</span>
            </div>

            <!-- Battery Capacity -->
            <div class="form-group">
                <label for="battery_kwh">Battery Capacity (kWh)</label>
                <select id="battery_kwh" name="battery_kwh" class="form-control" aria-describedby="battery-hint">
                    <option value="0">No battery</option>
                    <option value="2.5">2.5 kWh (small)</option>
                    <option value="5" selected>5 kWh (standard)</option>
                    <option value="7.5">7.5 kWh</option>
                    <option value="10">10 kWh (large)</option>
                    <option value="12.5">12.5 kWh</option>
                    <option value="15">15 kWh (max)</option>
                </select>
                <span id="battery-hint" class="hint">Home storage battery &mdash; select &ldquo;No battery&rdquo; to simulate PV only</span>
            </div>

            <!-- Annual Consumption -->
            <div class="form-group">
                <label for="consumption_kwh">Annual Consumption (kWh)</label>
                <input
                    type="number"
                    id="consumption_kwh"
                    name="consumption_kwh"
                    class="form-control"
                    min="1000"
                    max="8000"
                    step="100"
                    value="3400"
                    required
                    aria-describedby="consumption-hint"
                >
                <span id="consumption-hint" class="hint">Typical UK household uses 2,700&ndash;4,000 kWh/year</span>
            </div>

            <!-- Location -->
            <div class="form-group">
                <label for="location">Location</label>
                <select id="location" name="location" class="form-control" aria-describedby="location-hint">
                    <option value="bristol" selected>Bristol</option>
                    <option value="london">London</option>
                    <option value="edinburgh">Edinburgh</option>
                    <option value="manchester">Manchester</option>
                </select>
                <span id="location-hint" class="hint">Solar irradiance varies by UK region</span>
            </div>

            <!-- Simulation Period -->
            <div class="form-group">
                <label for="days">Simulation Period</label>
                <select id="days" name="days" class="form-control" aria-describedby="days-hint">
                    <option value="7" selected>7 days (one week)</option>
                    <option value="30">30 days (one month)</option>
                    <option value="90">90 days (one season)</option>
                    <option value="365">365 days (full year)</option>
                </select>
                <span id="days-hint" class="hint">Longer periods give more representative averages</span>
            </div>

        </div><!-- /.form-grid -->

        <div class="form-actions mt-lg">
            <button
                type="submit"
                id="submit-btn"
                class="btn btn--primary"
            >
                <span class="btn-label">&#9654; Run Simulation</span>
                <span id="loading-indicator" class="htmx-indicator" aria-live="polite">
                    <span class="spinner" aria-hidden="true"></span>
                    Running&hellip;
                </span>
            </button>
        </div>

    </form>
</div><!-- /.card -->

<!-- Results section — populated by HTMX after simulation -->
<div id="results-section" class="mt-lg" aria-live="polite"></div>

<script>
    (function () {
        "use strict";

        /**
         * Compute ISO date strings for hidden start/end fields
         * based on the selected number of simulation days.
         * Uses a fixed summer reference start (2024-06-01) for short runs
         * and a full calendar year (2024-01-01 → 2024-12-31) for 365 days.
         */
        var REFERENCE_START = new Date("2024-06-01");

        function addDays(date, n) {
            var d = new Date(date.getTime());
            d.setDate(d.getDate() + n - 1);
            return d;
        }

        function toISODate(date) {
            var y = date.getFullYear();
            var m = String(date.getMonth() + 1).padStart(2, "0");
            var d = String(date.getDate()).padStart(2, "0");
            return y + "-" + m + "-" + d;
        }

        function updateDates() {
            var daysSelect = document.getElementById("days");
            var startInput = document.getElementById("start-date");
            var endInput = document.getElementById("end-date");

            if (!daysSelect || !startInput || !endInput) { return; }

            var days = parseInt(daysSelect.value, 10);

            if (days === 365) {
                startInput.value = "2024-01-01";
                endInput.value = "2024-12-31";
            } else {
                startInput.value = toISODate(REFERENCE_START);
                endInput.value = toISODate(addDays(REFERENCE_START, days));
            }
        }

        // Initialise on page load
        updateDates();

        // Update whenever the days select changes
        var daysSelect = document.getElementById("days");
        if (daysSelect) {
            daysSelect.addEventListener("change", updateDates);
        }
    }());
</script>
{% endblock %}
