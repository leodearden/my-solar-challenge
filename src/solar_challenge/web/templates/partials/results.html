{#
    results.html — HTMX partial injected into #results-section after POST /simulate.

    Expected template variables:
        summary         dict  – serialisable summary stats stored in Flask session
        energy_chart_json   str   – Plotly JSON figure for daily energy flows
        battery_chart_json  str | None – Plotly JSON figure for battery SOC (None if no battery)
        has_battery     bool  – True when a battery was configured for this simulation
#}

<!-- ===== Results Header ===== -->
<div class="page-intro mt-lg" id="results-header">
    <h2 class="page-title">Simulation Results</h2>
    <p class="page-subtitle text-muted">
        {{ summary.simulation_days }}-day simulation complete &mdash;
        scroll down to see charts and download options.
    </p>
</div>

<!-- ===== Summary Statistics ===== -->
<div class="card">
    <h3 class="card__title">Summary Statistics</h3>
    <div class="stats-grid">

        <div class="stat-card">
            <div class="stat-card__value">{{ "%.1f"|format(summary.total_generation_kwh) }}</div>
            <div class="stat-card__label">Total Generation (kWh)</div>
        </div>

        <div class="stat-card">
            <div class="stat-card__value">{{ "%.1f"|format(summary.total_demand_kwh) }}</div>
            <div class="stat-card__label">Total Demand (kWh)</div>
        </div>

        <div class="stat-card">
            <div class="stat-card__value">{{ "%.1f"|format(summary.total_self_consumption_kwh) }}</div>
            <div class="stat-card__label">Self-Consumption (kWh)</div>
        </div>

        <div class="stat-card">
            <div class="stat-card__value">{{ "%.1f"|format(summary.total_grid_import_kwh) }}</div>
            <div class="stat-card__label">Grid Import (kWh)</div>
        </div>

        <div class="stat-card">
            <div class="stat-card__value">{{ "%.1f"|format(summary.total_grid_export_kwh) }}</div>
            <div class="stat-card__label">Grid Export (kWh)</div>
        </div>

        {% if has_battery %}
        <div class="stat-card">
            <div class="stat-card__value">{{ "%.1f"|format(summary.total_battery_charge_kwh) }}</div>
            <div class="stat-card__label">Battery Charged (kWh)</div>
        </div>

        <div class="stat-card">
            <div class="stat-card__value">{{ "%.1f"|format(summary.total_battery_discharge_kwh) }}</div>
            <div class="stat-card__label">Battery Discharged (kWh)</div>
        </div>
        {% endif %}

        <div class="stat-card">
            <div class="stat-card__value">{{ "%.0f"|format(summary.self_consumption_ratio * 100) }}%</div>
            <div class="stat-card__label">Self-Consumption Ratio</div>
        </div>

        <div class="stat-card">
            <div class="stat-card__value">{{ "%.0f"|format(summary.grid_dependency_ratio * 100) }}%</div>
            <div class="stat-card__label">Grid Dependency</div>
        </div>

        <div class="stat-card">
            <div class="stat-card__value">{{ "%.0f"|format(summary.export_ratio * 100) }}%</div>
            <div class="stat-card__label">Export Ratio</div>
        </div>

        <div class="stat-card">
            <div class="stat-card__value">{{ "%.1f"|format(summary.peak_generation_kw) }}</div>
            <div class="stat-card__label">Peak Generation (kW)</div>
        </div>

        <div class="stat-card">
            <div class="stat-card__value">{{ "%.1f"|format(summary.peak_demand_kw) }}</div>
            <div class="stat-card__label">Peak Demand (kW)</div>
        </div>

    </div><!-- /.stats-grid -->
</div><!-- /.card -->

<!-- ===== Energy Flow Chart ===== -->
<div class="card mt-lg">
    <h3 class="card__title">Daily Energy Flows</h3>
    <div id="energy-flow-chart" class="chart-container" role="img" aria-label="Daily energy flows chart"></div>
</div>

{% if has_battery %}
<!-- ===== Battery State of Charge Chart ===== -->
<div class="card mt-lg">
    <h3 class="card__title">Battery State of Charge</h3>
    <div id="battery-soc-chart" class="chart-container" role="img" aria-label="Battery state of charge chart"></div>
</div>
{% endif %}

<!-- ===== Download Actions ===== -->
<div class="card mt-lg">
    <h3 class="card__title">Download Results</h3>
    <p class="text-muted" style="margin-bottom: 1rem;">
        Export the raw time-series data or a human-readable summary report.
    </p>
    <div class="download-actions">
        <a href="{{ url_for('main.download_csv') }}" class="btn btn--secondary">
            &#8595;&nbsp;Download CSV
        </a>
        <a href="{{ url_for('main.download_report') }}" class="btn btn--outline">
            &#8595;&nbsp;Download Report
        </a>
        <a href="{{ url_for('main.index') }}" class="btn btn--outline">
            &#8635;&nbsp;New Simulation
        </a>
    </div>
</div>

<!-- ===== Plotly Chart Initialisation ===== -->
<script>
    (function () {
        "use strict";

        /**
         * Render energy-flow chart using inline Plotly JSON serialised by the server.
         * The server passes a complete Plotly figure dict (data + layout) as a JSON string.
         */
        var energyFigure = {{ energy_chart_json | safe }};
        Plotly.newPlot(
            "energy-flow-chart",
            energyFigure.data,
            energyFigure.layout,
            { responsive: true, displayModeBar: true, scrollZoom: false }
        );

        {% if has_battery %}
        /**
         * Render battery state-of-charge chart only when a battery is configured.
         */
        var batteryFigure = {{ battery_chart_json | safe }};
        Plotly.newPlot(
            "battery-soc-chart",
            batteryFigure.data,
            batteryFigure.layout,
            { responsive: true, displayModeBar: true, scrollZoom: false }
        );
        {% endif %}
    }());
</script>
